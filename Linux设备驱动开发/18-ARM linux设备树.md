[toc]

## 设备树

### ARM设备树的起源

​		设备树是一种**描述硬件的数据结构**，在linux2.6中，ARM架构的板级硬件细节过多地被硬编码在`arch/arm/plat_xxx`和`arch/arm/mach_xxx`中，采用设备树后，许多硬件的细节可以直接通过它传递给linux，而不再需要在内核中进行大量的冗余编码。

​		设备树由一系列被命名的**节点**和**属性**组成，而**节点本身可包含子节点**。所谓**属性**，其实就是**成对出现的名称和值**。在设备树中，可描述的信息包括：CPU的数量和类别，内存基地址和大小，总线和桥，外设连接，中断控制器和中断使用情况，GPIO控制器和GPIO使用情况，时钟控制器和时钟使用情况。

​		它基本就是构建一颗由CPU、总线、设备组成的树，BootLoader会将这棵树传递给内核，然后内核可以识别这棵树，并根据它展开出linux内核中的`platform_device`、`spi_device`等设备，而这些设备用到的内存、IRQ等资源，也被传递给了内核，内核会将这些资源绑定给展开的相应的设备。

### 设备树的组成和结构

​		整个设备树牵涉面比较广，即增加了新的用于描述设备硬件信息的文本格式，又增加了编译这个文本的工具，同时BootLoader也需要支持将编译后的设备树传递给linux内核。

#### 1、DTS、DTC和DTB等

##### （1）DTS

​		文件.dts是一种ASCII文本格式的设备树描述，基本上在ARM linux中，一个.dts文件对应一个ARM的设备，一般放置在内核的arch/arm/boot/dts/目录中。

​		由于一个soc可能对应多个设备(一个soc可以对应多个产品和电路板)，这些.dts文件势必包含许多共同的部分，为了简化，把soc公用的部分或者多个设备共同的部分一般提炼为.dtsi，类似于C语言的头文件。和C语言的头文件类似，.dtsi也可以包括其他的.dtsi。

​		**文件.dts(或者其他包括的.dtsi)的基本元素即为前文所述的节点和属性**。

##### （2）DTC——device tree compiler

​		DTC是将.dts编译为.dtb的工具，其源代码位于内核的scripts/dtc目录中，在linux内核使能了设备树的情况下，编译内核的时候主机工具DTC会被编译出来，对应于scripts/dtc/Makefile中“hostprogs-y := dtc”这一hostprogs的编译目标。

##### （3）DTB——device tree blob

​		文件.dtb是.dts被DTC编译后的二进制格式的设备树描述，可由linux内核解析，当然U-Boot这样的BootLoader也是可以识别.dtb的。