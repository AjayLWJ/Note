## linux内核概述

### linux内核的组成

#### 1. Linux 内核源代码的目录结构  

Linux 内核源代码包含如下目录。
● arch ：包含和硬件体系结构相关的代码，每种平台占一个相应的目录，如 i386、 arm、arm64、 powerpc、 mips 等。 Linux 内核目前已经支持 30 种左右的体系结构。在 arch目录下，存放的是各个平台以及各个平台的芯片对 Linux 内核进程调度、内存管理、中断等的支持，以及每个具体的 SoC 和电路板的板级支持代码。
● block：块设备驱动程序 I/O 调度。
● crypto：常用加密和散列算法（如 AES、 SHA 等），还有一些压缩和 CRC 校验算法。
● documentation：内核各部分的通用解释和注释。
● drivers ：设备驱动程序，每个不同的驱动占用一个子目录，如 char、 block、 net、mtd、 i2c 等。
● fs：所支持的各种文件系统，如 EXT、 FAT、 NTFS、 JFFS2 等。
● include：头文件，与系统相关的头文件放置在 include/linux 子目录下。
● init：内核初始化代码。著名的 start_kernel() 就位于 init/main.c 文件中。
● ipc：进程间通信的代码。
● kernel ：内核最核心的部分，包括进程调度、定时器等，而和平台相关的一部分代码放在 arch/kernel 目录下。
● lib：库文件代码。
● mm：内存管理代码，和平台相关的一部分代码放在 arch/mm 目录下。
● net：网络相关代码，实现各种常见的网络协议。
● scripts：用于配置内核的脚本文件。
● security：主要是一个 SELinux 的模块。
● sound： ALSA、 OSS 音频设备的驱动核心代码和常用设备驱动。
● usr：实现用于打包和压缩的 cpio 等。
● include：内核 API 级别头文件。	

​		内核一般要做到 drivers 与 arch 的软件架构分离，驱动中不包含板级信息，让驱动跨平台。同时内核的通用部分（如 kernel、 fs、 ipc、 net 等）则与具体的硬件（ arch 和 drivers）剥离。  

#### 2. linux内核的组成部分

​		Linux 内核主要由**进程调度**（ SCHED）、 **内存管理**（ MM）、**虚拟文件系统**（ VFS）、**网络接口**（ NET）和**进程间通信**（ IPC） 5个子系统组成。  

![Linux 内核的组成部分与关系](.\image\Linux 内核的组成部分与关系.png)

​		a) 进程调度	

​		调度控制系统中的多个进程对 CPU 的访问，使得多个进程能在 CPU 中**“微观串行，宏观并行”**地执行。进程调度处于系统的中心位置，内核中其他的子系统都依赖它，因为每个子系统都需要挂起或恢复进程。    

​		如图所示， Linux 的进程在几个状态间进行切换。

![image-20200603094302857](.\image\Linux 进程状态转换.png)

​		在设备驱动编程中，当请求的资源不能得到满足时，驱动一般会调度其他进程执行，并使本进程进入睡眠状态，直到它请求的资源被释放，才会被唤醒而进入就绪状态。睡眠分成可中断的睡眠和不可中断的睡眠，两者的区别在于可中断的睡眠在收到信号的时候会醒。  

​		在 Linux 内核中，使用 **task_struct 结构体**来描述进程，该结构体中包含**描述该进程内存资源、文件系统资源、文件资源、 tty 资源、信号处理等的指针**。 Linux 的**线程采用轻量级进程模型**来实现，在用户空间通过 **pthread_create() API 创建线程**的时候，本质上内核只是创建了一个新的 task_struct，并将新 task_struct 的所有资源指针都指向创建它的那个 task_struct的资源指针。  